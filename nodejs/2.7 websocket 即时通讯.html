<html>
<head>
  <title>2.7 websocket 即时通讯</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win32);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="906"/>
<h1>2.7 websocket 即时通讯</h1>

<div>
<span><div>http是单向通信  客户端请求服务端   服务端响应返回客户端</div><div><br/></div><div>一、socket</div><div><img src="2.7 websocket 即时通讯_files/Image.png" type="image/png"/></div><div><br/></div><div><br/></div><div><br/></div><div>二、h5 的 websocket - 实时通信  （在客户端使用的协议，h5标准）</div><div><br/></div><div> 1、h5 中的 websocket协议，弥补http的单向通信，实现浏览器与服务器的<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>全双工通信</b></span>，使服务端也能主动向客户端发送数据。</div><div><br/></div><div><br/></div><div>websocket   h5标准：        </div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">var ws = new WebSocket(&quot;ws://127.0.0.1:8080&quot;);</span></div><div style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">ws.onopen = function( ){</span></div><div style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">   </span> <span style="background-color: rgb(255, 250, 165); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;-evernote-highlight:true;">//连接成功调用</span></div><div style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">}</span></div><div style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">ws.onmessage = function( ){</span></div><div style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">   </span> <span style="background-color: rgb(255, 250, 165); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;-evernote-highlight:true;">//服务器给客户端发消息</span></div><div style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">} </span></div><div style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">ws.onclose = function( ){</span></div><div style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">   </span> <span style="background-color: rgb(255, 250, 165); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;-evernote-highlight:true;">//服务器断掉</span></div><div style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">}</span></div><div style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 12pt;">ws.send(发送消息给服务器)；</span></div><div><font color="#333333" face="Monaco" size="4"><span style="line-height: 23px;">//只接受字符串</span></font></div></div><div><br/></div><div><br/></div><div>        </div><div>2、websocketServer &lt;=nodejs (及时通信功能)</div><div><br/></div><div>    （1）<span style="font-size: 9pt;">nodejs 自带的</span> <span style="font-weight: bold;">net</span>模块 能够实现websocketServer 创建</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">net</span></div><div><br/></div></div><div>    </div><div>    （2） nodejs 第三方的 <span style="font-weight: bold;">ws</span>模块能都实现websocketServer 创建</div><div><br/></div><div>    （3）nodejs 第三方的 <span style="font-weight: bold;">socketio</span>模块 能都实现websocketServer 创建，</div><div><span>    <span>    <span>    Websocket仅仅是 Socket.io实现实时通信的一个子集</span></span></span><br/></div><div><span>    <span>    <span>    </span></span></span> 分为两部分：</div><div>           <span>    </span> 第一，客户端部分=》如果浏览器支持websocket，进行websocket接口调用，不支持就轮询；</div><div>            <span>    </span>第二，服务端部分=》websocketServer响应，轮询响应。</div><div><img src="2.7 websocket 即时通讯_files/Image [1].png" type="image/png" style="font-size: 9pt;"/></div><div><br/></div><div><br/></div><div>express -e test</div><div>cd test</div><div>npm install </div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">/////////////////////////////////////////www</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">/</span><span style="font-size: 8pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">/创建socket server 利用socket.io模块  需要安装</span></div><div><span style="font-size: 8pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">var io = require(&quot;socket.io&quot;)(server);</span></div><div><span style="font-size: 8pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">io.on(&quot;connection&quot;,function(item){</span></div><div><span style="font-size: 8pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">    item.emit(&quot;welcome&quot;,&quot;balbalbal&quot;);</span></div><div><span style="font-size: 8pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">})</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">///////////////////////////////////////////socketio.js</span></div><div><br/></div><div><br/></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">//////////////////////////////////////////app.js</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">var socket = require();</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">app.use(&quot;/socket&quot;,socket);</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">//////////////////////////////////////////socketio.ejs</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><img src="2.7 websocket 即时通讯_files/Image [2].png" type="image/png" style="font-family: Monaco; font-size: 8pt; color: rgb(51, 51, 51);"/></span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><img src="2.7 websocket 即时通讯_files/Image [3].png" type="image/png" style="font-family: Monaco; font-size: 8pt; color: rgb(51, 51, 51);"/></span></div></div><div><br/></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">/////////////////////////////////////////www</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">//创建socket server 利用ws模块</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">var WebSocket = require(&quot;ws&quot;);</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">var wss = new WebSocket.Server({port:8080});</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">wss.on(&quot;connection&quot;,function(ws){</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    wss.on(&quot;connection&quot;,function(ws){</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        wss.on(&quot;message&quot;,function(msg){</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">            //遍历所有的连接的客户端，给每个客户端发消息</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">            wss.clients.forEach(fuction(item){</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">                </span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">                if(item!=ws){ //排除自己</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">                    </span><span style="font-size: 8pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">item.send(msg);</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">                }</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">            })</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        </span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        })</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        ws.send(&quot;&quot;);  //socket server 给客户端发送的信息</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    })</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">   </span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">})</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 9pt;">//////////////////////////////////////index.ejs</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 9pt;">&lt;script&gt;</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;">    var ws = new WebSocket(&quot;ws://127.0.0.1:8080&quot;);</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;">    ws.onopen = function( ){</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;">   </span> <span style="background-color: rgb(255, 250, 165); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;-evernote-highlight:true;">//连接成功调用</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;">}</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;">    ws.onmessage = function( ){</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;">   </span> <span style="background-color: rgb(255, 250, 165); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;-evernote-highlight:true;">//服务器给客户端发消息</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;">} </span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;">    ws.onclose = function( ){</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;">   </span> <span style="background-color: rgb(255, 250, 165); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;-evernote-highlight:true;">//服务器断掉</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;">}</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt;">ws.send(发送消息给服务器)；</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 9pt;">&lt;/script&gt;</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 9pt;">////////////////////////////////////</span></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div><div>npm </div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div> </div><div><br/></div></span>
</div></body></html> 